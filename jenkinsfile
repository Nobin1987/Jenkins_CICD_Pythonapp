pipeline {
    agent any
    environment {
        GIT_REPO = "https://github.com/Nobin1987/Jenkins_CICD_Pythonapp.git"
        SSH_CRED_ID = "prashant-deploy"
        EC2_USER = "ubuntu"
        EC_HOST = "3.110.142.165"
        BUILD_STATUS = "SUCESS"  // Default
        VENV_PATH = "/tmp/${env.JOB_NAME}-${env.BUILD_ID}-venv"
    }
    triggers {
        githubPush()
    }

    stages {
        stage('Code cloning') {
            steps {
                echo 'Cloning the code'
                git branch: 'main' , url : "${env.GIT_REPO}"
            }
        }
        // stage('Build') {
        //     steps {
        //         echo 'Building the code'
        //         sh 'pip3 install -r requirement.txt'
        //     }
       // }
        // stage('Set Up Environment') {
        //     steps {
        //         script {
        //             echo 'Setting up virtual environment...'
        //             // Create a virtual environment
        //             sh 'python3 -m venv venv'
        //             // Activate the virtual environment and install dependencies
        //             sh '. venv/bin/activate && pip install -r requirements.txt'
        //         }
        //     }
        // }

        // stage('Test') {
        //     steps {
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             script {
        //                 echo 'Running unit tests...'
        //                 // Activate the virtual environment and run tests
        //                 sh '. venv/bin/activate && pytest tests/test_app.py --maxfail=1 --disable-warnings'
        //             }
        //         }
        //     }
        // }


    
    stages {
        stage('Build') {
            steps {
                sh """
                    python3 -m venv ${VENV_PATH}
                    . ${VENV_PATH}/bin/activate
                    pip install -r requirements.txt
                """
            }
        }

        stage('Test') {
            steps {
                sh """
                    . ${VENV_PATH}/bin/activate
                    pytest
                """
            }
        }
        }
        stage('Push to EC2') {
            when {
                expression {
                    return currentBuild.result == null || currentBuild.result == 'SUCCESS'
                }
            }
            steps {
                echo 'Copy the code '
            }
        
    }
    
}
}